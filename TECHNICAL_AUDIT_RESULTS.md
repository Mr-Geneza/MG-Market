# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç MLM-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã MG-market
## –î–∞—Ç–∞: 2025-01-13

---

## üéØ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1Ô∏è‚É£ –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê - –ò–°–ü–†–ê–í–õ–ï–ù–ê ‚úÖ

#### –ü—Ä–æ–±–ª–µ–º–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ, –Ω–æ `sponsor_id` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è
- –í –∞–¥–º–∏–Ω–∫–µ –∫–æ–ª–æ–Ω–∫–∞ "–ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π" –±—ã–ª–∞ –ø—É—Å—Ç–æ–π
- –ö–æ–º–∏—Å—Å–∏–∏ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å

#### –†–µ—à–µ–Ω–∏–µ:

**A. –°–æ–∑–¥–∞–Ω–∞ –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:**

**–§–∞–π–ª:** `src/components/Auth/RegisterForm.tsx`
- ‚úÖ **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏** - –Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ—Ñ-–∫–æ–¥–∞ –î–û —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞** —á–µ—Ä–µ–∑ `validate_referral_code()`
- ‚úÖ **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- ‚úÖ **–î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞ –ø—Ä–∏–≤—è–∑–∫–∏ —Å–ø–æ–Ω—Å–æ—Ä–∞:**
  1. Backend trigger `auto_bind_sponsor_from_metadata` (—Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç BEFORE INSERT)
  2. Explicit call `bind_referral()` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö —à–∞–≥–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[REGISTER]`

**B. –°–æ–∑–¥–∞–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ RPC —Ñ—É–Ω–∫—Ü–∏–∏:**

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –ú–∏–≥—Ä–∞—Ü–∏—è `20251113_fix_referral_functions.sql`

1. **`validate_referral_code(p_ref_code TEXT)`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ø–æ–Ω—Å–æ—Ä–∞
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{valid: true/false, sponsor_id, sponsor_name, error}`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **`admin_backfill_sponsor_from_metadata()`**
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ sponsor_id –∏–∑ `auth.users.raw_user_meta_data`
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `referrals`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `referrer_snapshot` –≤ –ø—Ä–æ—Ñ–∏–ª—è—Ö
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –∫–Ω–æ–ø–∫–∞ "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏" –≤ –∞–¥–º–∏–Ω–∫–µ

**C. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã):**

1. **`auto_bind_sponsor_from_metadata`** (BEFORE INSERT –Ω–∞ `profiles`)
   - –ß–∏—Ç–∞–µ—Ç `inviter_ref_code` –∏–∑ `auth.users.raw_user_meta_data`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `sponsor_id` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è

2. **`trigger_ensure_referral_on_insert`** (AFTER INSERT –Ω–∞ `profiles`)
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `referrals` (structure_type = 1)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ `direct_referrals_count` —É —Å–ø–æ–Ω—Å–æ—Ä–∞

**D. –ó–∞—Ö–≤–∞—Ç –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞:**

**–§–∞–π–ª—ã:** `src/hooks/useReferralCapture.tsx`, `src/utils/cookies.ts`
- ‚úÖ **–¢—Ä–æ–π–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:** Cookie (30 –¥–Ω–µ–π) + localStorage + sessionStorage
- ‚úÖ **–ù–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏** –ø–æ —Å–∞–π—Ç—É
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏

**E. –ê–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:**

**–§–∞–π–ª:** `src/hooks/useReferralBind.tsx`
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–≤—è–∑–∞—Ç—å —Å–ø–æ–Ω—Å–æ—Ä–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª —Å —Ä–µ—Ñ-–∫–æ–¥–æ–º –≤ –∫—É–∫–∞—Ö
- ‚úÖ Retry logic (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å exponential backoff)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ LoginForm

---

### 2Ô∏è‚É£ –õ–û–ì–ò–ö–ê –ü–û–î–ü–ò–°–û–ö –ò –ó–ê–ö–ê–ó–û–í - –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ê ‚úÖ

#### –ü—Ä–æ–±–ª–µ–º–∞:
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö —Å —Ä–∞–∑–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
- useConfirmPayment –Ω–∞–ø—Ä—è–º—É—é –æ–±–Ω–æ–≤–ª—è–ª —Å—Ç–∞—Ç—É—Å—ã, –º–∏–Ω—É—è unified handler
- –ö–æ–º–∏—Å—Å–∏–∏ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

#### –†–µ—à–µ–Ω–∏–µ:

**A. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π:**

**–§–∞–π–ª:** `src/hooks/useSubscriptions.tsx` ‚Üí `useConfirmPayment()`

**–î–û:**
```typescript
// ‚ùå –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã - –∫–æ–º–∏—Å—Å–∏–∏ –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è
await supabase.from('subscriptions').update({
  status: 'active',
  started_at: now,
  expires_at: now + 1 year
}).eq('id', id);
```

**–ü–û–°–õ–ï:**
```typescript
// ‚úÖ –í—ã–∑–æ–≤ unified handler - –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
await supabase.rpc('approve_subscription_payment', {
  p_subscription_id: id,
  p_admin_id: admin_id,
  p_comment: comment
});
```

**B. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã:**

**RPC —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ë–î:**
- ‚úÖ `approve_subscription_payment()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `process_payment_completion()`
- ‚úÖ `process_payment_completion()` - unified handler –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ–ø–ª–∞—Ç
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã (subscription/order)
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π (—á–µ—Ä–µ–∑ DB triggers)
  - –õ–æ–≥–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  - **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã

**C. –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏:**

**–§—É–Ω–∫—Ü–∏—è:** `process_payment_completion()` –≤ –ë–î
- ‚úÖ –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `activation_due_from = now() + 1 month`
- ‚úÖ –ü–µ—Ä–≤—ã–π –º–µ—Å—è—Ü —Å—á–∏—Ç–∞–µ—Ç—Å—è ¬´–Ω—É–ª–µ–≤—ã–º¬ª - –ø—Ä–∞–≤–æ –Ω–∞ –≤—ã–ø–ª–∞—Ç—ã –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–æ –≤—Ç–æ—Ä–æ–≥–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ UI: `ActivationProgress.tsx` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥

**D. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

**–§–∞–π–ª:** `src/hooks/useSubscriptions.tsx`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[CONFIRM_PAYMENT]`
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —à–∞–≥–∏: RPC call, result, invalidation

---

## üìã –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (–ü–†–û–í–ï–†–ï–ù–ê)

### Database Triggers (–∞–∫—Ç–∏–≤–Ω—ã):

1. **Subscription S1 Commission** (`create_s1_commission_on_subscription`)
   - –ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç 10% –∫–æ–º–∏—Å—Å–∏—é —Å–ø–æ–Ω—Å–æ—Ä—É (S1)
   - –ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞ –Ω–∞ 7 –¥–Ω–µ–π

2. **Order P1-P10 Commissions** (`create_commission_transactions`)
   - –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ 10 —É—Ä–æ–≤–Ω—è–º –≤–≤–µ—Ä—Ö
   - –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∞–±–ª–∏—Ü—ã `mlm_commission_rules`

3. **Activation Structure** (`handle_activation_structure`)
   - –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞ —Å activation products –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ secondary structure (type=2)

4. **Activity Logging** (`log_activation_activity`, `log_registration_activity`)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –≤ `activity_log` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

### Referral Workflow:

```
USER CLICKS LINK
  ‚Üì
/register?ref=ABC123
  ‚Üì
useReferralCapture() ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ cookies/localStorage/sessionStorage
  ‚Üì
RegisterForm.handleRegister()
  ‚îú‚îÄ validate_referral_code() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  ‚îú‚îÄ signUp() - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ —Å metadata.inviter_ref_code
  ‚îú‚îÄ TRIGGER: auto_bind_sponsor_from_metadata ‚Üí sponsor_id = ...
  ‚îú‚îÄ TRIGGER: trigger_ensure_referral_on_insert ‚Üí INSERT referrals
  ‚îî‚îÄ bind_referral() - explicit backup call
      ‚Üì
SPONSOR LINKED ‚úÖ
```

### Payment Workflow:

```
USER PAYS FOR SUBSCRIPTION/ORDER
  ‚Üì
Admin clicks "–û–¥–æ–±—Ä–∏—Ç—å" in /admin/users or /admin/payments
  ‚Üì
useConfirmPayment() OR useManualPayment.approvePayment()
  ‚Üì
RPC: approve_subscription_payment() / process_payment_completion()
  ‚îú‚îÄ UPDATE subscriptions/orders status = 'active'/'paid'
  ‚îú‚îÄ UPDATE profiles subscription_status, activation_due_from, etc.
  ‚îú‚îÄ TRIGGER: create_s1_commission_on_subscription ‚Üí commission S1
  ‚îú‚îÄ TRIGGER: create_commission_transactions ‚Üí commissions P1-P10
  ‚îî‚îÄ INSERT activity_log
      ‚Üì
COMMISSIONS CALCULATED ‚úÖ
```

---

## üß™ –ü–õ–ê–ù –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### TEST CASE 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ

**–®–∞–≥–∏:**
1. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ-–∫–æ–¥ –ª—é–±–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `5b1797b9`)
2. –û—Ç–∫—Ä—ã—Ç—å: `https://mg-market.kz/register?ref=5b1797b9`
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É: –§–ò–û, Email, –¢–µ–ª–µ—Ñ–æ–Ω, –ü–∞—Ä–æ–ª—å
4. –ù–∞–∂–∞—Ç—å "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
- ‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ: "–ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π: [–ò–º—è —Å–ø–æ–Ω—Å–æ—Ä–∞]"
- ‚úÖ –í –ë–î `profiles.sponsor_id` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ –í –ë–î `referrals` —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å (structure_type=1)
- ‚úÖ –í `/admin/users` –∫–æ–ª–æ–Ω–∫–∞ "–ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º—è —Å–ø–æ–Ω—Å–æ—Ä–∞
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ª–æ–≥–∏ `[REGISTER]` –±–µ–∑ –æ—à–∏–±–æ–∫

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```sql
SELECT 
  p.email,
  p.sponsor_id,
  p.referrer_snapshot,
  sp.full_name as sponsor_name,
  r.id as referral_record_id
FROM profiles p
LEFT JOIN profiles sp ON sp.id = p.sponsor_id
LEFT JOIN referrals r ON r.referred_user_id = p.id AND r.structure_type = 1
WHERE p.email = 'test_new_user@example.com';
```

---

### TEST CASE 2: –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ —Ä–µ—Ñ-–∫–æ–¥–∞

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å: `https://mg-market.kz/register` (–ë–ï–ó `?ref=`)
2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
3. –ù–∞–∂–∞—Ç—å "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é –ø–∞—Ä—Ç–Ω—ë—Ä–∞"
- ‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ù–ï —Å–æ–∑–¥–∞–Ω
- ‚úÖ –í –ë–î –ù–ï–¢ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏

---

### TEST CASE 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–®–∞–≥–∏:**
1. –í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É `/admin/users`
2. –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —Å–ø–æ–Ω—Å–æ—Ä–∞ (–∫–æ–ª–æ–Ω–∫–∞ "–ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π" = "‚Äî")
3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ: "–°–≤—è–∑–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: –æ–±–Ω–æ–≤–ª–µ–Ω–æ X, –ø—Ä–æ–≤–∞–ª–µ–Ω–æ Y"
- ‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `inviter_ref_code` –≤ metadata —Ç–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–µ–Ω `sponsor_id`
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ `"column u.user_metadata does not exist"`

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
-- –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ sponsor_id, –Ω–æ —Å metadata
SELECT p.id, p.email, p.sponsor_id, u.raw_user_meta_data->>'inviter_ref_code' as ref_code
FROM profiles p
JOIN auth.users u ON u.id = p.id
WHERE p.sponsor_id IS NULL
  AND u.raw_user_meta_data->>'inviter_ref_code' IS NOT NULL;
```

---

### TEST CASE 4: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∞–¥–º–∏–Ω–æ–º

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É (Dashboard ‚Üí "–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é")
2. –ê–¥–º–∏–Ω –∑–∞—Ö–æ–¥–∏—Ç –≤ `/admin/users` –∏–ª–∏ `/admin/payments`
3. –ù–∞—Ö–æ–¥–∏—Ç –∑–∞—è–≤–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã"
4. –ù–∞–∂–∏–º–∞–µ—Ç "–û–¥–æ–±—Ä–∏—Ç—å", –≤–≤–æ–¥–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ "–ê–∫—Ç–∏–≤–Ω–∞"
- ‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–∏–ª—Å—è `subscription_status = 'active'`
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `activation_due_from = now() + 1 month`
- ‚úÖ **–ö–æ–º–∏—Å—Å–∏—è S1 (10%) –Ω–∞—á–∏—Å–ª–µ–Ω–∞ —Å–ø–æ–Ω—Å–æ—Ä—É** (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ `transactions`)
- ‚úÖ –ö–æ–º–∏—Å—Å–∏—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞ –Ω–∞ 7 –¥–Ω–µ–π
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ –ª–æ–≥–∏ `[CONFIRM_PAYMENT]` –±–µ–∑ –æ—à–∏–±–æ–∫

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–∏—Å—Å–∏–π:**
```sql
SELECT 
  t.id,
  t.user_id,
  p.full_name as earner_name,
  t.amount_cents / 100.0 as amount_usd,
  t.type,
  t.level,
  t.structure_type,
  t.frozen_until,
  t.source_ref,
  t.payload
FROM transactions t
JOIN profiles p ON p.id = t.user_id
WHERE t.source_id = '[subscription_id]'  -- –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ ID –ø–æ–¥–ø–∏—Å–∫–∏
ORDER BY t.created_at DESC;
```

---

### TEST CASE 5: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Å –ø—Ä–æ–¥—É–∫—Ç–æ–º-–∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
2. –ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É –∑–∞–∫–∞–∑–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ = "paid"
- ‚úÖ **–ö–æ–º–∏—Å—Å–∏–∏ P1-P10 –Ω–∞—á–∏—Å–ª–µ–Ω—ã** –≤—Å–µ–º –≤—ã—à–µ—Å—Ç–æ—è—â–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- ‚úÖ –ï—Å–ª–∏ —Å—É–º–º–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ –º–µ—Å—è—Ü >= required_sum, —Ç–æ `monthly_activation_completed = true`
- ‚úÖ –í `activity_log` —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å —Å `type = 'activation'`

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ –∑–∞–∫–∞–∑—É
SELECT 
  t.level,
  p.full_name as earner_name,
  t.amount_cents / 100.0 as amount_usd,
  t.frozen_until
FROM transactions t
JOIN profiles p ON p.id = t.user_id
WHERE t.source_ref LIKE 'order_[order_id]%'  -- –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ ID –∑–∞–∫–∞–∑–∞
ORDER BY t.level;
```

---

## üîí –ì–ê–†–ê–ù–¢–ò–ò –°–ò–°–¢–ï–ú–´

### ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (UI –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫—É)
- –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (`validate_referral_code` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞)
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–æ–π–¥–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é, RPC –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É

### ‚úÖ Sponsor_id –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ—Ç—Å—è
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ BEFORE INSERT trigger (–¥–æ –∑–∞–ø–∏—Å–∏ –≤ –ë–î)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ explicit `bind_referral()` call
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞–ø—Ä–µ—â–∞—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –º–µ–Ω—è—Ç—å `sponsor_id` –Ω–∞–ø—Ä—è–º—É—é

### ‚úÖ –ö–æ–º–∏—Å—Å–∏–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –í–°–ï–ì–î–ê
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞: `process_payment_completion()`
- DB triggers —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã (–∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ `source_ref` unique constraint)

### ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- `[REGISTER]` - –≤—Å–µ —à–∞–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `[CONFIRM_PAYMENT]` - –≤—Å–µ —à–∞–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- –õ–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (console) + edge function logs (Supabase dashboard)

---

## üö® –ò–ó–í–ï–°–¢–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### 1. –°—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ metadata
- –ï—Å–ª–∏ –≤ `auth.users.raw_user_meta_data` –Ω–µ—Ç `inviter_ref_code`, –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ "–ü—Ä–∏–≤—è–∑–∞—Ç—å —Å–ø–æ–Ω—Å–æ—Ä–∞" –≤—Ä—É—á–Ω—É—é (–∞–¥–º–∏–Ω–∫–∞)

### 2. –ü–µ—Ä–≤—ã–π –º–µ—Å—è—Ü –ø–æ–¥–ø–∏—Å–∫–∏
- –õ–æ–≥–∏–∫–∞ "–Ω—É–ª–µ–≤–æ–≥–æ –º–µ—Å—è—Ü–∞" —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ `activation_due_from`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ UI –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `ActivationProgress.tsx`)

### 3. RPC —Ç–∏–ø—ã –≤ TypeScript
- –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `src/integrations/supabase/types.ts`
- –ï—Å–ª–∏ TypeScript –æ—à–∏–±–∫–∏ –Ω–µ –∏—Å—á–µ–∑–ª–∏ - –æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç

---

## üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –î–ê–õ–¨–ù–ï–ô–®–ï–ô –†–ê–ó–†–ê–ë–û–¢–ö–ò

### 1. Monitoring
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É: % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ sponsor_id
- –ê–ª–µ—Ä—Ç, –µ—Å–ª–∏ % > 1% (—á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å)

### 2. Admin UI
- –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫—Ä–∞—Å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ sponsor_id –≤ `/admin/users`
- –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–æ–º–∏—Å—Å–∏–∏" (–≤—ã–∑—ã–≤–∞–µ—Ç `admin_recalculate_commissions`)

### 3. Testing
- –°–æ–∑–¥–∞—Ç—å E2E —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ–ø–ª–∞—Ç—ã
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è RPC —Ñ—É–Ω–∫—Ü–∏–π

### 4. Documentation
- –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É commission_plan_levels
- –î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É flow –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π

---

## ‚úÖ –ò–¢–û–ì–ò –ê–£–î–ò–¢–ê

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ‚úÖ **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:** –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª–∞, –¥–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞
2. ‚úÖ **–õ–æ–≥–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ RPC
3. ‚úÖ **–ö–æ–º–∏—Å—Å–∏–∏:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ unified handler
4. ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è backfill –∏–∑ metadata
5. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω—è–ª–æ—Å—å:
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î (—Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã)
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ RPC —Ñ—É–Ω–∫—Ü–∏–∏ (–∫—Ä–æ–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö)
- ‚úÖ –ë–æ–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ DB triggers (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã)

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (TEST CASE 1, 2)
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (TEST CASE 3)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π (TEST CASE 4, 5)
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏ edge functions
5. –ï—Å–ª–∏ –≤—Å—ë –û–ö - –ø–æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `/admin/cleanup`

---

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏—Ç–∞:** 2025-01-13  
**Senior Developer:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é